USE "%DATABASE%";

ALTER TABLE "Reports" ADD "Query" VARCHAR(4096);

UPDATE "Settings" SET "Value" = '2017.6.4' WHERE "Key" = 'Version Number';

SET FOREIGN_KEY_CHECKS=0;
DELETE FROM "reports" WHERE "GUID"='b88b0031fc2844eb874c5be27f8be003';
DELETE FROM "securables" WHERE "GUID"='b88b0031fc2844eb874c5be27f8be003';
DELETE FROM "report filters" WHERE "GUID"='62a2b59571a84b36b4f267cb0c9356e1';
DELETE FROM "report blocks" WHERE "GUID"='f0e0abf91c4646b8b8c84d9708dcc848';
DELETE FROM "report blocks" WHERE "GUID"='781c05819fae400281f2c12d836a1d1b';
DELETE FROM "report blocks" WHERE "GUID"='8e1134185167428caceccc3172a93aea';
DELETE FROM "report blocks" WHERE "GUID"='f3c904df452e4a4a8d1ff5611a2a6d43';
DELETE FROM "report blocks" WHERE "GUID"='be3823b2e800477b8cbca5ef4377b299';
INSERT INTO "reports" ( "Auto Load",  "Display Name",  "GUID",  "HTML Template",  "Query",  "Title" ) VALUES (0, 'Report - Accounting - Aged Receivables', 'b88b0031fc2844eb874c5be27f8be003', '<style>\r\n    table a { text-decoration: none; }\r\n</style>\r\n\r\n<table width="100%">\r\n    <!-- BEGIN ContactTypes -->\r\n    <tr><td>&nbsp;</td></tr>\r\n    <tr><td>&nbsp;</td></tr>\r\n    <tr><td colspan="6"><h2>{ContactTypeName}</h2></td></tr>\r\n\r\n    <!-- BEGIN Contacts -->\r\n    \r\n    <tr><td>&nbsp;</td></tr>\r\n    <tr><td colspan="6"><h3>{Contact}</h3></td></tr>\r\n    <tr>\r\n        <td class="black">Date</td>\r\n        <td class="black">Type</td>\r\n        <td class="black">Number</td>\r\n        <td class="black right">Total</td>\r\n        <td class="black right">Balance</td>\r\n        <td class="black right">Age</td>\r\n    </tr>\r\n    \r\n    <!-- BEGIN Documents -->\r\n    <tr>\r\n        <td><a href="{Edit URL}&GUID={GUID}">{Date}</a></td>\r\n        <td><a href="{Edit URL}&GUID={GUID}">{Type}</a></td>\r\n        <td><a href="{Edit URL}&GUID={GUID}">{Number}</a></td>\r\n        <td class="right"><a href="{Edit URL}&GUID={GUID}">{Total}</a></td>\r\n        <td class="right"><a href="{Edit URL}&GUID={GUID}">{Balance}</a></td>\r\n        <td class="right"><a href="{Edit URL}&GUID={GUID}">{Age}</a></td>\r\n    </tr>\r\n    <!-- END Documents -->\r\n    <!-- BEGIN DocumentTotals -->\r\n    <tr>\r\n        <td>&nbsp;</td>\r\n        <td>&nbsp;</td>\r\n        <td>&nbsp;</td>\r\n        <td>&nbsp;</td>\r\n        <td class="right" style="border-top: 1pt solid black;">{Balance}</td>\r\n        <td>&nbsp;</td>\r\n    </tr>\r\n    <!-- END DocumentTotals -->\r\n    <!-- END Contacts -->\r\n    <!-- END ContactTypes -->\r\n\r\n    <tr><td>&nbsp;</td></tr>\r\n    <tr><td>&nbsp;</td></tr>\r\n    <tr><td colspan="6"><h2>Totals</h2></td></tr>\r\n    <tr>\r\n        <td>&nbsp;</td>\r\n        <td>&nbsp;</td>\r\n        <td>&nbsp;</td>\r\n        <td>&nbsp;</td>\r\n        <td class="right black">{Balance}</td>\r\n        <td>&nbsp;</td>\r\n    </tr>\r\n</table>\r\n', 'DROP TABLE IF EXISTS "AgedReceivables";\r\nCREATE TEMPORARY TABLE "AgedReceivables" (\r\n\t"Contact" VARCHAR(128),\r\n    "Contact Type" VARCHAR(64),\r\n    "Date" DATE,\r\n    "Type" VARCHAR(64),\r\n    "Number" VARCHAR(128),\r\n    "Total" DECIMAL(64,2),\r\n    "Balance" DECIMAL(64,2),\r\n    "Age" INT,\r\n    "Edit URL" VARCHAR(255),\r\n    "GUID" VARCHAR(32),\r\n    "Contacts GUID" VARCHAR(32),\r\n    "Contact Types GUID"  VARCHAR(32)\r\n);\r\n\r\nINSERT INTO "AgedReceivables"\r\nSELECT * \r\nFROM \r\n\t(\r\n\t\tSELECT\r\n\t\t\tC."Display Name" AS "Contact",\r\n\t\t\tCT."Display Name" AS "Contact Type",\r\n\t\t\tD."Date" AS "Date",\r\n\t\t\tTT."Name" AS "Type",\r\n\t\t\tD."Reference Number" AS "Number",\r\n\t\t\tCAST(D."Total" AS DECIMAL(16,2)) AS "Total",\r\n\t\t\tCAST(D."Total" - IFNULL((\r\n\t\t\t\tSELECT\r\n\t\t\t\t\tSUM( PA."Amount" * CASE\r\n\t\t\t\t\t\t\tWHEN PT."Is Sales Related" = DT."Is Sales Related" THEN 1\r\n\t\t\t\t\t\t\tELSE -1\r\n\t\t\t\t\tEND )\r\n\t\t\t\tFROM \r\n\t\t\t\t\t"Payment Applications" PA\r\n\t\t\t\t\tJOIN "Payments" P ON PA."Payments GUID" = P."GUID"\r\n\t\t\t\t\tJOIN "Payment Types" PT ON P."Payment Types GUID" = PT."GUID"\r\n\t\t\t\tWHERE \r\n\t\t\t\t\t"Documents GUID" = D."GUID"\r\n                    AND DATE(P."Date") <= DATE({As Of})\r\n\t\t\t), 0) AS DECIMAL(16,2)) AS "Balance",\r\n\t\t\tDATEDIFF(DATE({As Of}), D."Date") AS "Age",\r\n\t\t\tTT."Edit URL" AS "Edit URL",\r\n\t\t\tD."GUID" AS "GUID",\r\n\t\t\tC."GUID" AS "Contacts GUID",\r\n\t\t\tCT."GUID" AS "Contact Types GUID"\r\n\t\tFROM \r\n\t\t\t"Documents" D\r\n\t\t\tJOIN "Contacts" C ON D."Contacts GUID" = C."GUID"\r\n\t\t\tJOIN "Contact Types" CT ON CT."GUID" = C."Contact Types GUID"\r\n\t\t\tJOIN "Document Types" DT ON DT."GUID" = D."Document Types GUID"\r\n\t\t\tJOIN "Transaction Types" TT ON DT."GUID" = TT."GUID"\r\n\t\tWHERE\r\n\t\t\tDATE(D."Date") <= DATE({As Of})\r\n            AND "Document Types GUID" IN ( \r\n                SELECT "GUID" FROM "Document Types" \r\n                WHERE "Is Posting" = 1 AND "Is Sales Related" = 1\r\n            )\r\n\t) TBL \r\nWHERE\tTBL."Balance" <> 0\r\nORDER BY\r\n\t"Contact Type",\r\n\t"Contact",\r\n    "Date",\r\n    "Number",\r\n    "Balance";', 'Aged Receivables' );
INSERT INTO "securables" ( "Display Name",  "GUID" ) VALUES ('Report - Report - Accounting - Aged Receivables', 'b88b0031fc2844eb874c5be27f8be003');
INSERT INTO "report filters" ( "Data Type",  "GUID",  "Priority",  "Prompt",  "Query",  "Reports GUID" ) VALUES ('Date', '62a2b59571a84b36b4f267cb0c9356e1', 1, 'As Of', 'SELECT DATE(NOW()) AS "Value"', 'b88b0031fc2844eb874c5be27f8be003' );
INSERT INTO "report blocks" ( "GUID",  "Name",  "Parent Block GUID",  "Priority",  "Reports GUID",  "SQL Query" ) VALUES ('f0e0abf91c4646b8b8c84d9708dcc848', 'ContactTypes', NULL, 1, 'b88b0031fc2844eb874c5be27f8be003', 'SELECT DISTINCT "Contact Type" FROM "AgedReceivables" ORDER BY "Contact Type";' );
INSERT INTO "report blocks" ( "GUID",  "Name",  "Parent Block GUID",  "Priority",  "Reports GUID",  "SQL Query" ) VALUES ('781c05819fae400281f2c12d836a1d1b', 'Contacts', 'f0e0abf91c4646b8b8c84d9708dcc848', 0, NULL, 'SELECT DISTINCT "Contact", "Contacts GUID" FROM "AgedReceivables" WHERE "Contact Type" = {Contact Type} ORDER BY "Contact";' );
INSERT INTO "report blocks" ( "GUID",  "Name",  "Parent Block GUID",  "Priority",  "Reports GUID",  "SQL Query" ) VALUES ('8e1134185167428caceccc3172a93aea', 'Documents', '781c05819fae400281f2c12d836a1d1b', 0, NULL, 'SELECT * FROM "AgedReceivables" WHERE "Contacts GUID" = {Contacts GUID};' );
INSERT INTO "report blocks" ( "GUID",  "Name",  "Parent Block GUID",  "Priority",  "Reports GUID",  "SQL Query" ) VALUES ('f3c904df452e4a4a8d1ff5611a2a6d43', 'DocumentTotals', '781c05819fae400281f2c12d836a1d1b', 1, NULL, 'SELECT\r\n    SUM("Balance") AS "Balance",\r\n    CEIL(AVG("Age")) AS "Age"\r\nFROM ( SELECT * FROM "AgedReceivables" WHERE "Contacts GUID" = {Contacts GUID} ) SQ2\r\nORDER BY\r\n\t"Contact Type",\r\n\t"Contact",\r\n    "Date",\r\n    "Number",\r\n    "Balance"' );
INSERT INTO "report blocks" ( "GUID",  "Name",  "Parent Block GUID",  "Priority",  "Reports GUID",  "SQL Query" ) VALUES ('be3823b2e800477b8cbca5ef4377b299', 'Totals', NULL, 2, 'b88b0031fc2844eb874c5be27f8be003', 'SELECT\r\n    SUM("Balance") AS "Balance",\r\n    CEIL(AVG("Age")) AS "Age"\r\nFROM (\r\n\r\nSELECT * FROM "AgedReceivables"\r\n\r\n) TBL2' );
SET FOREIGN_KEY_CHECKS=1
